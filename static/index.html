<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Persona-AI 데모 · 실시간 화자별 스트림</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root {
      --bg: #0b1220; --card:#101a33; --ink:#eaf0ff; --muted:#a6b3d9; --border:#1c2745;
      --accent:#7aa2ff; --chip:#142044;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; color: var(--ink); background: var(--bg); }
    header { position: sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background: rgba(11,18,32,.7); border-bottom:1px solid var(--border); padding:12px 18px; display:flex; gap:12px; align-items:center; }
    header h1 { font-size:16px; margin:0; font-weight:700; }
    header .controls { margin-left:auto; display:flex; gap:8px; }
    .btn { border:1px solid var(--border); background:var(--card); color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn:hover { border-color:#294081; }
    .wrap { display:grid; grid-template-columns: 2.1fr 1fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto; }
    .panel { background: var(--card); border:1px solid var(--border); border-radius:14px; }
    .panel h2 { font-size:14px; margin:0; padding:10px 14px; border-bottom:1px solid var(--border); color:var(--muted); }
    #log { padding:14px; height: calc(100vh - 140px); overflow:auto; }
    .msg { display:flex; gap:12px; margin:12px 0; }
    .avatar { width:38px; height:38px; border-radius:50%; flex:none; display:grid; place-items:center; font-size:12px; color:#0b1220; font-weight:800; }
    .bubble { background:#121b31; border:1px solid #1f2a4a; border-radius:14px; padding:10px 14px; flex:1; }
    .meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center;}
    .text { font-size:15px; line-height:1.55; white-space:pre-wrap; }
    .chips { display:flex; gap:6px; padding:10px 12px; flex-wrap:wrap; }
    .chip { background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .stats { padding:12px; font-size:14px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>🧑‍💻 Persona-AI · 실시간 화자별 스트림</h1>
    <div class="controls">
      <button class="btn" id="btnStart">▶ 스트림 시작</button>
      <button class="btn" id="btnClear">🧹 지우기</button>
    </div>
  </header>

  <div class="wrap">
    <section class="panel">
      <h2>대화 스트림</h2>
      <div id="log"></div>
    </section>

    <aside class="panel">
      <h2>개요</h2>
      <div class="stats" id="stats">연결 대기…</div>
      <div class="chips" id="speakers"></div>
    </aside>
  </div>

  <script>
    const colors = {};
    function colorFor(s){
      if (colors[s]) return colors[s];
      const hues = [210,260,310,160,20,40];
      const h = hues[Math.floor(Math.random()*hues.length)];
      return (colors[s] = `hsl(${h} 70% 70%)`);
    }
    function initials(s){ return (s || "?").slice(0,3); }
    function fmt(t){
      const mm = Math.floor(t / 60);
      const ss = String(Math.floor(t % 60)).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    const log = document.getElementById("log");
    const stats = document.getElementById("stats");
    const speakers = document.getElementById("speakers");

    const socket = io("http://localhost:8099", { transports: ["websocket"] });

    socket.on("connect", () => {
      stats.textContent = "서버 연결됨 · transcript.json 감시 중";
    });

    document.getElementById("btnStart").onclick = () => {
      socket.emit("start_stream", {});
    };
    document.getElementById("btnClear").onclick = () => {
      log.innerHTML = ""; speakers.innerHTML = "";
      for (const k of Object.keys(colors)) delete colors[k];
      stats.textContent = "화면 초기화 완료";
    };

    const seen = new Set();
    socket.on("transcript", (r) => {
      if (!seen.has(r.speaker)) {
        seen.add(r.speaker);
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = r.speaker;
        speakers.appendChild(chip);
      }
      const el = document.createElement("div");
      el.className = "msg";
      el.innerHTML = `
        <div class="avatar" style="background:${colorFor(r.speaker)}">${initials(r.speaker)}</div>
        <div class="bubble">
          <div class="meta"><b>${r.speaker}</b> <span class="time">${fmt(r.start)}–${fmt(r.end)}</span></div>
          <div class="text">${(r.text || "").replace(/</g, "&lt;")}</div>
        </div>`;
      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    });
  </script>
</body>
</html>
